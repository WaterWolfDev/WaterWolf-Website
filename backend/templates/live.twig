{% extends "layouts/site.twig" %}

{% block content %}
<div class="container page">
    <h1 class="section-title">WaterWolf Live</h1>
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab"
                            data-bs-target="#html5" type="button"
                            role="tab" aria-controls="html5"
                            aria-selected="true">HTML5 Player
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab"
                            data-bs-target="#twitch" type="button"
                            role="tab" aria-controls="twitch">Twitch Stream
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab"
                            data-bs-target="#m3u8" type="button"
                            role="tab" aria-controls="m3u8">HLS Player
                    </button>
                </li>
            </ul>
        </div>
        <div class="tab-content card-body">
            <div id="html5" class="container tab-pane active">
                <div class="ratio ratio-16x9">
                    <video id="html5video" controls>
                        <source src="https://stream.vrcdn.live/live/waterwolf.live.mp4" type="video/mp4">
                        Your browser does not support HTML5 video.
                    </video>
                </div>
            </div>
            <div id="twitch" class="container tab-pane fade">
                <div id="twitch-embed"></div>
            </div>
            <div id="m3u8" class="container tab-pane fade">
                <div class="ratio ratio-16x9">
                    <video id="m3u8video" controls></video>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script src="https://embed.twitch.tv/embed/v1.js"></script>

<script>
    ready(() => {
        $('[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            var currentTab = $(e.target).data('bs-target'); // Get the current tab

            if (currentTab === '#html5') {
                $('#twitchvideo')[0].contentWindow.postMessage('{"event":"pause"}', '*');
                $('#html5video')[0].play();
                if (hls) {
                    hls.stopLoad();
                }
            } else if (currentTab === '#twitch') {
                $('#html5video')[0].pause();
                if (hls) {
                    hls.stopLoad();
                }

                setupTwitch();
            } else if (currentTab === '#m3u8') {
                $('#html5video')[0].pause();
                $('#twitchvideo')[0].contentWindow.postMessage('{"event":"pause"}', '*');
                setupHls();
            }
        });

        let twitchEmbed;

        function setupTwitch() {
            if (!twitchEmbed) {
                twitchEmbed = new Twitch.Embed("twitch-embed", {
                    width: "100%",
                    height: 480,
                    channel: "waterwolfvr",
                    autoplay: true
                });
            }
        }

        let hls;

        function setupHls() {
            if (Hls.isSupported()) {
                var video = document.getElementById('m3u8video');
                hls = new Hls();
                hls.loadSource('http://stream.waterwolf.live/hls/0/stream.m3u8'); // Replace with your M3U8 file URL
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    video.play();
                });
            }
            // HLS.js is not supported on platforms that do not have Media Source Extensions (MSE) enabled.
            else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = 'http://stream.waterwolf.live/hls/0/stream.m3u8'; // Replace with your M3U8 file URL
                video.addEventListener('loadedmetadata', function () {
                    video.play();
                });
            }
        }
    });
</script>
{% endblock %}
